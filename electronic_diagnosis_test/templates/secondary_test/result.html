{% extends "base.html" %}
{% load static %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!--user result-->

<div class="container my-4" lang="ar" dir="rtl" id="result-root">

  <!-- Top ribbon -->
  <div class="d-flex gap-2 mb-3 d-print-none">
    <button class="btn btn-outline-secondary" onclick="window.print()">
      <i class="bi bi-printer"></i> طباعة
    </button>
  </div>
<div class="">
  <!-- ====== الجزء (أ): البيانات الشخصية ====== -->
  <section class="sheet mb-4 ">
    <div class="ribbon">
      <span class="tag tag-orange">كرّاسة النتائج والتوصيات</span>
      <span class="tag tag-purple">اختبار القراءة والإملاء المقنّن للأطفال</span>
    </div>

    <div class="notebooks">
      <h2 class="section-title">الجزء (أ): البيانات الشخصية</h2>
      <div class="row g-3">
        <div class="col-12 col-md-6 ">
          <div class="field"><label>اسم المفحوص رباعياً:</label> <span>{{ student.name }}</span></div>
          <div class="field"><label>اسم المدرسة:</label> <span>{{ student.school }}</span></div>
          <div class="field fieldoneline"><label>المنطقة التعليمية:</label> <span>{{ student.District }}</span></div>
          <div class="field fieldoneline"><label>جنسية الفحوص:</label> <span>{{ student.nationality }}</span></div>
        <!--<div class="col-md-6">-->

                        <div class="d-grid mx-auto">
                    <table class="table-style">
                        <tr>
                            <th id="style-th"> </th>
                            <th id="style-th" style="text-align: center;">اليوم</th>
                            <th id="style-th" style="text-align: center;">الشهر</th>
                            <th id="style-th" style="text-align: center;">السنة</th>
                        </tr>
                        <tr>
                            <td>تاريخ إجراء الاختبار:</td>
                            <td class="td-style">{{student.examDate|date:'d'}}</td>
                            <td class="td-style">{{student.examDate|date:'m'}}</td>
                            <td class="td-style">{{student.examDate|date:'Y'}}</td>
                        </tr>
                        <tr>
                            <td>تاريخ ميلاد المفحوص:</td>
                            <td class="td-style">{{student.birthDate|date:'d'}}</td>
                            <td class="td-style">{{student.birthDate|date:'m'}}</td>
                            <td class="td-style">{{student.birthDate|date:'Y'}}</td>
                        </tr>
                        <tr>
                            <td>العمر:</td>
                            <td class="td-style">{{student.age_day}}</td>
                            <td class="td-style">{{student.age_month}}</td>
                            <td class="td-style">{{student.age_year}}</td>
                        </tr>
                    </table>
                </div>
   
        </div>
        <div class="col-12 col-md-6 ">
        <div class=" field col-md-6 d-flex align-items-center gap-2 gender-line">
        <label class="">جنس المفحوص:</label>
        <label class="ms-2">
          <input type="checkbox" {% if student.gender == 'male' %}checked{% endif %} disabled> ذكر
        </label>
        <label class="ms-3">
          <input type="checkbox" {% if student.gender == 'female' %}checked{% endif %} disabled> أنثى
        </label>
      </div>
          
          <div class="field"><label>السنة الدراسية:</label> <span>{{ student.grade }}</span></div>

        </div>
      </div>

 
<div class="row g-3 mt-2">
  <div class="col-12 d-flex">
    <div class="field flex-fill me-4">
      <label>اسم الفاحص:</label>
      <span>{{ student.examiner }}</span>
    </div>
    <div class="field flex-fill">
      <label>التخصص:</label>
      <span>{{ student.specalist }}</span>
    </div>
  </div>
</div>


      </div>

  </section>

    <!-- ====== الجزء (ب): تدوين الدرجات ====== -->
  <section class="sheet mb-4 page-break">


    <div class="notebooks">
      <h2 class="section-title">الجزء (ب): تدوين الدرجات</h2>
          <div class="table-responsive">
      <table class="table-style">
        <thead class="table-light">
          <tr>
            <th class="text-center">اسم الاختبار</th>
            <th class="text-center">الزمن (ث)</th>
            <th class="text-center">الدرجة الخام</th>
            <th class="text-center">الرتبة المئينية</th>
            <th class="text-center">الدرجة المعيارية المعدلة</th>
          </tr>
        </thead>
        <tbody>

          <tr>
            <td class="td-style-result">١ - اختبار دقة قراءة الكلمة المفردة</td>
            <td class="text-center td-style"></td>
            <td class="td-style-border">{{ test1.raw_score }}</td>
            <td class="td-style-border">{{ results.test1.percentile }}</td>
            <td class="td-style-border">{{ results.test1.std  }}</td>

          </tr>
          <tr>
            <td class="td-style-result">٢ - اختبار الطلاقة في فهم المقروء </td>
            <td class="td-style-border">{{ test2.time_sec }}</td>
            <td class="td-style-border">{{ test2.raw_score }}</td>
            <td class="td-style-border">{{ results.test2.percentile }}</td>
            <td class="td-style-border">{{ results.test2.std }}</td>

          </tr>
          <tr>
            <td class="td-style-result">٣ - اختبار إملاء الكلمة  </td>
            <td class="text-center td-style"></td>
            <td class="td-style-border">{{ test3.raw_score }}</td>
            <td class="td-style-border">{{ results.test3.percentile }}</td>
            <td class="td-style-border">{{ results.test3.std }}</td>

          </tr>
          <tr>
            <td class="td-style-result">٤ - اختبار فهم المقروء القطعة  </td>
            <td class="text-center td-style"></td>
            <td class="td-style-border">{{ test4.raw_score }}</td>
            <td class="td-style-border">{{ results.test4.percentile }}</td>
            <td class="td-style-border">{{ results.test4.std }}</td>

          </tr>

          <tr class="fw-bold">
            <td class="td-style">الزمن الكلي والدرجة الكلية:</td>
            <td class="text-center td-style"></td>
            <td class="td-style-border">{{ total_raw_score }}</td>
            <td class="td-style-border">{{ total_percentile}}</td>
            <td class="td-style-border">{{ total_std }}</td>

          </tr>
        </tbody>
      </table>
    </div>




      </div>
  </section>

    <!-- ====== الجزء (ج): ====== -->
  <section class="sheet mb-4 page-break">


    <div class="notebooks">
      <h2 class="section-title">الجزء (ج): تمثيل الرتب المئينية للاختبارات الفرعية تمثيلا بيانياً</h2>
      <div class="table-responsive mb-3">
    <table class="table table-bordered align-middle tiny-cells mb-0 std-grid">
      <thead>
        <tr>
          <th class="text-center">الوصف<br>الكيفي</th>
          <th class="text-center"> الرتبة  <br> المئينية</th>
          {% for row in chart_rows_std %}
          <th class="text-center">{{ row.pct_label }}</th>
          {% endfor %}

        </tr>
      </thead>
      <tbody>
        {% for labels, percentile_labels in chart_data %}
        <tr {% if percentile_labels|floatformat:0 == '50' %} class="highlight" {% endif %}>
          <td class="text-center fw-semibold">{{ labels }}</td>
          <td class="text-center fw-semibold">{{percentile_labels}}</td>
        {% for test in chart_rows_std %}
          <td class="text-center {% if test.hit_index == forloop.parentloop.counter0 %}hit{% endif %}"></td>
        {% endfor %}
          {% for v in chart_rows_std.cells %}
            <td class="text-center {% if v == 1 %}hit{% endif %}"></td>
          {% endfor %}
        </tr>
        </tr>
        {% empty %}
        <tr><td colspan="16" class="text-center text-muted">لا توجد بيانات</td></tr>
        {% endfor %}
      </tbody>
    </table>


  </div>

    <div class="container-box card-signin chart-wrap" style="width: 1000px;margin-top: 2%">
    <canvas id="myChart" width="400" height="200"></canvas>
</div>


    </div>
  </section>


<style>
  .table-purple { background:#720e9e; color:#fff; }
  .percentile-grid td, .percentile-grid th { height:32px; vertical-align:middle; }
  .percentile-grid td.hit { background:#e6e3e6; font-weight:700; }
</style>


  <section class="sheet mb-4 page-break">


  <div class="notebooks">
      <h2 class="section-title">الجزء (د): التقرير النهائي والتوصيات</h2>
    <div class="table-responsive mb-3">
        <!-- section H-->
<div class="container-box card-signin" style="width: 1000px; margin-top: 2%; text-align: right; direction: rtl;">
    <div class="card-body">
        <form method="POST" id="myForm">
            {% csrf_token %}
            <div class="row g-3 mx-auto" style="width: 850px;">
                <div class="modal-header mb-4">
                    <h2 class="modal-title text-lg-purple" style="text-align: right;">  </h2>
                </div>
                <div class="col-md-6" style="display: flex; flex-direction: row; justify-content: center; align-items:center;">
                    <label for="studentName" class=""> اسم المفحوص رباعيا: </label>
                    <input type="text" class="form-control" name="studentName" id="studentName" value="{{student.name}}" disabled>
                </div>
                <div class="col-md-6" style="display: flex; flex-direction: row; justify-content: right; align-items:center;">
                    <label for="sex" class="p-3"> جنس المفحوص:</label>
                    <label for="sex" class="p-2"> ذكر </label> {% if student.gender == "male" %}
                    <input type="checkbox" checked="true" disabled="disabled"> {% else %}
                    <input type="checkbox" disabled="disabled"> {%endif%}
                    <label for="sex" class="p-2"> أنثى </label> {% if student.gender == "female" %}
                    <input type="checkbox" checked="true" disabled="disabled"> {% else %}
                    <input type="checkbox" disabled="disabled"> {% endif %}
                </div>
            
                <div class="col-md-12" style="display: flex; flex-direction: row; justify-content: center; align-items:center;">
                    <label for="Examiner" class=""> اسم الفاحص:  </label>
                    <input type="text" class="form-control" name="Examiner" id="Examiner" value="{{student.examiner}}" disabled>
                </div>
                <div class="col-md-12">
                    <label for="note" class=""> ملاحظات على المفحوص قبل الاختبار وفي أثنائه:  </label>
                    <textarea type="text" class="form-control" name="note" id="note" rows="2" value="">{{note_latest}}</textarea>
                </div>


                <h4 style="color: #5E2B8C"> التفسير الكيفي للاختبار:</h4>

                <div class="form-group mb-3">
                    <label for="strength" class=""> اولا: نقاط القوة:   </label>
                    <textarea type="text" class="form-control" name="strength" id="strength" rows="5" value="">{{strength_latest}}</textarea>
                </div>

                <div class="form-group mb-3">
                    <label for="weakness" class=""> ثانيا: نقاط الضعف:  </label>
                    <textarea type="text" class="form-control" name="weakness" id="weakness" rows="5" value="">{{weakness_latest}}</textarea>
                </div>


                <div class="form-group mb-3">
                    <label for="result" class=""> النتيجة:  </label>
                    <textarea type="text" class="form-control" name="results" id="results" rows="5" value="">{{result_latest}}</textarea>
                </div>
<div class="page-break">
                <div class="form-group mb-3">
                    <label for="suggestion" class=""> توصيات مقترحة:  </label>
                    <textarea type="text" class="form-control" name="suggestion" id="suggestion" rows="5" value="">{{suggestion_latest}}</textarea>
                </div>
            </div>
            <div class="text-center d-print-none">
            <button class="btn-purple" type="submit" name="action" value="submit">
    تسليم
  </button>
</div>
</div>
            
        </form>

    </div>
</div>

  </div>




  </div>
  </section>
  </div>


</div>

<style>
  /* colors */
  .text-orange{color:#F29F05;}
  .text-red{color:#C41E3A;}
  .tag{padding:.4rem .8rem;border-radius:.5rem;color:#fff;font-weight:600}
  .tag-purple{background:#5E2B8C}
  .tag-orange{background:#F29F05}
  .ribbon{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.75rem}

  

  .field label{min-width:180px;font-weight:600}
  .field span{display:inline-block;min-width:180px;border-bottom:1px solid #ddd}

  .date-grid{display:grid;grid-template-columns:repeat(3,60px);gap:.4rem}
  .date-grid span{display:block;border:1px solid #ddd;border-radius:.4rem;height:36px}

  .result-table th, .result-table td{vertical-align:middle}
  .tiny-cells td, .tiny-cells th{height:28px}

  .chart-placeholder{height:220px;border:2px solid #c33;border-radius:.5rem}

  .notebook{border:2px solid #cc5500;border-radius:.5rem;padding:16px}
  .line-title{color:#1b6ac9;font-weight:700}
  .dotted-block{min-height:70px;border-bottom:1px dotted #888}
  .dotted-list{min-height:100px}
  .dotted-list li{min-height:22px}

  /* Print to A4 */

/* print styles */
@page { size: A4 portrait; margin: 12mm; }

@media print {
  html, body {
    width: 210mm;
    margin: 0;
    padding: 0;
  }

/* Make the column act full-width in print and avoid grid quirks */
  .col-12, .col-md-6 { width: 100% !important; float: none !important; }


  .gender-line{
    display: inline-flex !important;
    align-items: center !important;
    gap: 8mm !important;           /* space between ذكر / أنثى */
    white-space: nowrap !important;
    overflow: visible !important;
    padding: 0 !important;
    margin: 0 !important;
  }

  /* Keep each label with its box on one line */
  .gender-line > label{
    display: inline-flex !important;
    align-items: center !important;
    gap: 3mm !important;
    margin: 0 !important;
    white-space: nowrap !important;
  }

  .gender-line input[type="checkbox"]{
    appearance: none !important;
    -webkit-appearance: none !important;
    width: 13px; height: 13px;
    border: 1.6px solid #444;
    border-radius: 2px;
    background: #fff;
    margin: 0;                      
    position: relative;
    vertical-align: middle;
    opacity: 1 !important;
    filter: none !important;
    pointer-events: none !important;
  }

  .gender-line input[type="checkbox"]:checked::after{
    content: "✓";
    position: absolute;
    inset: -1px 0 0 0;
    font-size: 11px;
    line-height: 13px;
    text-align: center;
    color: #444;
    font-weight: 700;
  }

  .print-area {
    width: calc(210mm - 24mm);
    margin: 0 auto !important;   /* center */
    transform: scale(0.8);


    box-sizing: border-box;
  }

  .page-break { page-break-before: always; break-before: page; }
  .container, .container-fluid, .wrapper, .row {
    max-width: none !important;
    width: 100% !important;
    margin: 0 auto !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  table, .chart, .print-block {
    break-inside: avoid;
    page-break-inside: avoid;
    transform: scale(0.8);
  }

  img, svg, canvas {
    position: relative;
    transform-origin: center;
    max-width: 100% !important;
    height: auto !important;
    display: flex;
    margin: 0 auto; 
    justify-content: center;
    overflow: visible !important;
  }

  .chart-wrap {    
    display: flex;
    justify-content: center;
    display: block;
    width: 85% !important;
    max-width: 100% !important;
    height: auto !important;
    margin: 0 auto;
    }

  .print-center {
    display: block !important;
    margin-left: auto !important;
    margin-right: auto !important;
    float: none !important;
    position: static !important; 
    left: auto !important; right: auto !important;
  }

  .scale-center-90 {               
    position: relative !important;
    left: 50% !important;
    transform: translateX(-50%) scale(0.9) !important;
    transform-origin: top center !important;
    margin: 0 !important;
  }

  .print-center-parent {
    display: flex !important;
    justify-content: center !important;
    align-items: flex-start !important;
  }

  .row { margin: 0 !important; }
  [class*="col-"] { float: none !important; }




  .d-print-none, .no-print {
    display: none !important;
  }

    * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;      
    color-adjust: exact !important;           
  }
}

</style>

<script>
    // Let CSS control canvas size when printing
  window.onbeforeprint = () => {
    document.querySelectorAll('.chart-box canvas').forEach(c => {
      c.removeAttribute('width');
      c.removeAttribute('height');
    });

    document.querySelectorAll('table').forEach(c => {
      c.removeAttribute('width');
      c.removeAttribute('height');
    });
  };
    var labels = JSON.parse('{{ labels|escapejs }}');
    var data = JSON.parse('{{ data|escapejs }}');

    var ctx = document.getElementById('myChart').getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'الرتبة المئينية',
                data: data,
                backgroundColor: '#CC99CC',
                borderColor: '#CC99CC',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    ticks: {
                        stepSize: 10,
                        autoSkip: false,
                    },
          grid: {
          color: (c) => {
            const v = c.tick?.value;
            return (v !== undefined && Number(v) === 50) ? '#1e293b': '#cbd5e1';
          },
          lineWidth: (c) => {
            const v = c.tick?.value;
            return (v !== undefined && Number(v) === 50) ? 2: 1;
          }
        }
                    
                }
            }
        }

    });

</script>



{% endblock %}
